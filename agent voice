import numpy as np
import streamlit as st
from sklearn.linear_model import LogisticRegression
from gtts import gTTS
from openai import OpenAI

# =========================
# OPENAI CLIENT (NEW API)
# =========================
client = OpenAI(
    api_key="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"
)

# =========================
# DUMMY MODEL
# =========================
X_dummy = np.array([
    [38, 1, 0, 130, 150, 0, 0, 80, 0, 2.0, 0, 0, 0],
    [55, 0, 2, 120, 235, 1, 1, 142, 1, 1.8, 2, 1, 2],
    [65, 1, 3, 140, 210, 1, 2, 190, 1, 3.2, 1, 2, 1]
])
y_dummy = np.array([0, 1, 1])

model = LogisticRegression(max_iter=200)
model.fit(X_dummy, y_dummy)

# =========================
# SESSION STATE INIT
# =========================
if "predicted" not in st.session_state:
    st.session_state.predicted = False

if "call_active" not in st.session_state:
    st.session_state.call_active = False

# =========================
# UI
# =========================
st.set_page_config(page_title="Heart Disease Predictor", layout="wide")
st.markdown(
    "<h1 style='text-align:center;'>‚ù§Ô∏è Heart Disease Predictor</h1>",
    unsafe_allow_html=True
)
st.write("---")

# =========================
# INPUT FORM
# =========================
with st.form("patient_form"):
    name = st.text_input("Name")
    age = st.number_input("Age", 1, 120, 38)
    sex = st.selectbox("Gender", ["Male", "Female"])
    trestbps = st.number_input("Blood Pressure", 90, 200, 130)
    chol = st.number_input("Cholesterol", 100, 600, 150)
    submit = st.form_submit_button("üîç Predict")

# =========================
# PREDICT
# =========================
if submit:
    sex_val = 1 if sex == "Male" else 0

    input_data = np.array([
        age, sex_val, 0, trestbps, chol, 0,
        0, 80, 0, 2.0, 0, 0, 0
    ]).reshape(1, -1)

    proba = model.predict_proba(input_data)[0][1]
    result = "No heart disease detected." if proba < 0.5 else "Heart disease detected!"

    st.session_state.predicted = True
    st.session_state.proba = proba
    st.session_state.result = result
    st.session_state.age = age
    st.session_state.sex = sex
    st.session_state.bp = trestbps
    st.session_state.chol = chol

# =========================
# SHOW RESULT
# =========================
if st.session_state.predicted:
    st.success(f"Risk Probability: {st.session_state.proba*100:.2f}%")
    st.write(st.session_state.result)

    st.write("---")
    st.subheader("üìû AI Health Call Agent ‚Äì Diet Guidance")

    if st.button("üéôÔ∏è Call AI Agent"):
        st.session_state.call_active = True

# =========================
# CALL AGENT
# =========================
if st.session_state.call_active:

    st.success("üìû Call connected ‚Äì AI agent speaking")

    context = f"""
    Age: {st.session_state.age}
    Gender: {st.session_state.sex}
    Blood Pressure: {st.session_state.bp}
    Cholesterol: {st.session_state.chol}
    Risk: {st.session_state.proba*100:.2f}%
    Result: {st.session_state.result}
    """

    def ai_diet_agent(context):
        prompt = f"""
        You are a caring medical AI assistant.

        Speak for about one minute giving future diet advice.
        Include foods to eat, foods to avoid, daily habits,
        reassurance, and a short medical disclaimer.

        Patient Data:
        {context}
        """

        response = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": "You are a helpful medical AI assistant."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.5
        )

        return response.choices[0].message.content

    def generate_audio(text):
        tts = gTTS(text)
        audio_file = "diet_advice.mp3"
        tts.save(audio_file)
        return audio_file

    advice = ai_diet_agent(context)
    audio = generate_audio(advice)

    st.info("‚ñ∂Ô∏è Click PLAY to hear the AI agent")
    st.audio(audio)

    if st.button("üì¥ End Call"):
        st.session_state.call_active = False
        st.success("üì¥ Call ended")

st.caption("‚ö†Ô∏è AI guidance is for informational purposes only.")
