import numpy as np
import streamlit as st
from sklearn.linear_model import LogisticRegression
import smtplib
from email.message import EmailMessage
from fpdf import FPDF
from gtts import gTTS
from openai import OpenAI
import speech_recognition as sr
from pydub import AudioSegment

# =========================
# CONFIG
# =========================
OPENAI_API_KEY = "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"
SENDER_EMAIL = "nikhildhanpal03@gmail.com"
SENDER_APP_PASSWORD = "guyzaveafatrmert"

client = OpenAI(api_key=OPENAI_API_KEY)

# =========================
# UNICODE SAFE FUNCTION
# =========================
def clean_text(text):
    return text.encode("ascii", "ignore").decode("ascii")

# =========================
# MODEL
# =========================
X_dummy = np.array([
    [38, 1, 0, 130, 150, 0, 0, 80, 0, 2.0, 0, 0, 0],
    [55, 0, 2, 120, 235, 1, 1, 142, 1, 1.8, 2, 1, 2],
    [65, 1, 3, 140, 210, 1, 2, 190, 1, 3.2, 1, 2, 1]
])
y_dummy = np.array([0, 1, 1])

model = LogisticRegression(max_iter=200)
model.fit(X_dummy, y_dummy)

# =========================
# SESSION STATE
# =========================
if "predicted" not in st.session_state:
    st.session_state.predicted = False

# =========================
# UI (FIRST CODE STYLE)
# =========================
st.set_page_config(page_title="Heart Disease Predictor", layout="wide")

col1, col2, col3 = st.columns([1, 2, 1])
with col1:
    st.image("https://img.freepik.com/free-vector/doctor-character-background_1270-84.jpg", width=120)
with col2:
    st.markdown(
        "<h1 style='text-align:center;font-size:38px;'>Heart Disease Predictor Using Machine Learning</h1>",
        unsafe_allow_html=True
    )
with col3:
    st.image("https://img.freepik.com/free-vector/doctor-character-background_1270-84.jpg", width=120)

st.write("---")

# =========================
# INPUT FORM
# =========================
with st.form("user_form"):
    name = st.text_input("üë§ Name", "Mahesh")
    email = st.text_input("üìß Email", "example@gmail.com")

    st.subheader("üìù Patient Medical Inputs")
    c1, c2 = st.columns(2)

    with c1:
        age = st.number_input("Age", 1, 120, 38)
        sex = st.selectbox("Gender", ["Male", "Female"])
        cp = st.selectbox("Chest Pain Type", [0, 1, 2, 3])
        trestbps = st.number_input("Resting Blood Pressure", 130)
        chol = st.number_input("Cholesterol Level", 150)
        fbs = st.selectbox("Fasting Blood Sugar > 120?", [0, 1])

    with c2:
        restecg = st.selectbox("Resting ECG", ["Normal", "ST-T wave abnormality", "Left ventricular hypertrophy"])
        thalach = st.number_input("Maximum Heart Rate", 80)
        exang = st.selectbox("Exercise Induced Angina?", [0, 1])
        oldpeak = st.number_input("Old Peak", 2.0)
        slope = st.selectbox("Slope", [0, 1, 2])
        ca = st.selectbox("Major Vessels (0-3)", [0, 1, 2, 3])
        thal = st.selectbox("Thal Type", ["Normal", "Fixed Defect", "Reversible Defect"])

    st.subheader("üì∑ Capture Patient Image")
    img = st.camera_input("Take a picture")

    submitted = st.form_submit_button("üîç Predict")

# =========================
# PREDICTION + PDF + EMAIL
# =========================
if submitted:
    sex_val = 1 if sex == "Male" else 0
    restecg_val = {"Normal": 0, "ST-T wave abnormality": 1, "Left ventricular hypertrophy": 2}[restecg]
    thal_val = {"Normal": 0, "Fixed Defect": 1, "Reversible Defect": 2}[thal]

    input_data = np.array([
        age, sex_val, cp, trestbps, chol, fbs,
        restecg_val, thalach, exang, oldpeak,
        slope, ca, thal_val
    ]).reshape(1, -1)

    prob = model.predict_proba(input_data)[0][1]
    pred = model.predict(input_data)[0]

    result_text = "No heart disease detected." if pred == 0 else "Heart disease detected."

    st.markdown(f"### üßæ Overall Result: **{prob*100:.1f}%** chance of heart disease")
    st.success(result_text) if pred == 0 else st.error(result_text)

    data_dict = {
        "Age": age, "Gender": sex, "Chest Pain": cp,
        "Blood Pressure": trestbps, "Cholesterol": chol,
        "FBS > 120": fbs, "ECG": restecg,
        "Max Heart Rate": thalach, "Exercise Angina": exang,
        "Old Peak": oldpeak, "Slope": slope,
        "Major Vessels": ca, "Thal": thal
    }
    st.table([[k, v] for k, v in data_dict.items()])

    image_path = None
    if img:
        image_path = "patient_image.jpg"
        with open(image_path, "wb") as f:
            f.write(img.getbuffer())
        st.image(img, caption="Captured Image", use_column_width=True)

    # ---------- PDF ----------
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", "B", 16)
    pdf.cell(200, 10, "Heart Disease Medical Report", ln=True, align="C")
    pdf.set_font("Arial", size=12)

    pdf.cell(200, 8, clean_text(f"Name: {name}"), ln=True)
    pdf.cell(200, 8, clean_text(f"Email: {email}"), ln=True)
    pdf.cell(200, 8, clean_text(f"Risk: {prob*100:.1f}%"), ln=True)
    pdf.multi_cell(0, 8, clean_text(f"Result: {result_text}"))

    pdf.ln(3)
    pdf.cell(200, 8, "Diet & Lifestyle Guidance:", ln=True)
    pdf.multi_cell(
        0, 8,
        clean_text(
            "- Eat protein-rich foods (eggs, dal, fish, milk)\n"
            "- Reduce oil, salt, and sugar\n"
            "- Eat fruits and vegetables daily\n"
            "- Walk at least 30 minutes daily\n"
            "- Avoid smoking and alcohol\n"
        )
    )

    if image_path:
        pdf.image(image_path, x=10, w=70)

    pdf_path = "heart_report.pdf"
    pdf.output(pdf_path)

    with open(pdf_path, "rb") as f:
        st.download_button("üì• Download Report (PDF)", f, "heart_report.pdf")

    # ---------- EMAIL (DETAILED CONTENT) ----------
    msg = EmailMessage()
    msg["Subject"] = "Heart Disease Prediction ‚Äì Medical Report"
    msg["From"] = SENDER_EMAIL
    msg["To"] = email

    email_body = f"""
Dear {name},

Thank you for using the Heart Disease Predictor System.

Health Assessment Summary:
- Age: {age}
- Gender: {sex}
- Heart Disease Risk: {prob*100:.1f}%
- Result: {result_text}

Health & Lifestyle Guidance:
- Eat protein-rich foods (eggs, dal, fish, milk)
- Reduce oil, salt, and sugar
- Eat fruits and vegetables daily
- Walk at least 30 minutes every day
- Avoid smoking and alcohol

Please find attached:
- Your detailed medical report (PDF)
- Captured patient image (if provided)

Disclaimer:
This report is generated using a machine learning model and is for informational purposes only.
Please consult a certified doctor for medical decisions.

Regards,
Heart Disease Predictor App
"""

    msg.set_content(clean_text(email_body))

    with open(pdf_path, "rb") as f:
        msg.add_attachment(f.read(), maintype="application", subtype="pdf", filename="heart_report.pdf")

    if image_path:
        with open(image_path, "rb") as f:
            msg.add_attachment(f.read(), maintype="image", subtype="jpeg", filename="patient_image.jpg")

    with smtplib.SMTP("smtp.gmail.com", 587) as smtp:
        smtp.starttls()
        smtp.login(SENDER_EMAIL, SENDER_APP_PASSWORD)
        smtp.send_message(msg)

    st.success("üìß Email with detailed content, PDF & image sent successfully")

    st.session_state.predicted = True
    st.session_state.context = clean_text(f"""
Age: {age}
Gender: {sex}
Blood Pressure: {trestbps}
Cholesterol: {chol}
Risk: {prob*100:.1f}%
""")

# =========================
# üé§ AI VOICE AGENT
# =========================
if st.session_state.predicted:
    st.write("---")
    st.subheader("üé§ Talk to AI Health Assistant")

    patient_audio = st.audio_input("Speak your question")

    if patient_audio:
        audio_path = "patient_voice.wav"
        with open(audio_path, "wb") as f:
            f.write(patient_audio.getbuffer())

        AudioSegment.from_file(audio_path).export(audio_path, format="wav")

        r = sr.Recognizer()
        with sr.AudioFile(audio_path) as source:
            audio_data = r.record(source)

        try:
            patient_text = r.recognize_google(audio_data)
        except:
            st.error("Could not understand audio")
            st.stop()

        st.write(f"You said: {patient_text}")

        response = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": "You are a caring medical assistant."},
                {"role": "user", "content": clean_text(f"{st.session_state.context}\nQuestion: {patient_text}")}
            ]
        )

        reply = response.choices[0].message.content
        st.write(f"AI Response: {reply}")

        gTTS(clean_text(reply), lang="en").save("ai_reply.mp3")
        st.audio("ai_reply.mp3")

st.caption("‚ö†Ô∏è AI guidance is for informational purposes only.")
